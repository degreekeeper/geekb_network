### Урок 1. Сетевые модели (OSI TCP/IP). Энкапсуляция/декапсуляция




Для отправки клиентом на сервер электронной почты, используется протокол SMTP, который работает по портам TCP 25 и 587. Для получения протокол POP, который использует порты TCP 110 и 995. Не буду вдаваться в подробности взаимодействия на уровне приложения, т.е. между серверами и клиентами и буду считать что хосты напрямую передают/получают почту по протоколу SMTP через 25 порт TCP.


1. На 5 уровне приложений TCP/IP сформируется письмо, которое представляет из себя содержимое и заголовок SMTP размером 1024000 байт(1мбайт).
2. Пакет передается на уровень ниже на 4-ый транспортный уровень протоколу TCP. Тот разбивает сообщение на 16 сегментов, т.к. максимальный размер TCP-сегмента(пакета) 64Кбайта. Добавляет свой заголовок с портом назначения TCP 25, порт источника динамическим TCP 60025, номером сегмента и другой служебной информацией. Дальше идёт установление TCP-сесии между хостами 1.1.1.1 и 2.2.2.2. После чего данный протокол будет ещё контролировать подтвердила ли обратная сторона получение каждого сегмента и переотправлять их ещё раз в случае потерь.
3. Сегменты поочередно передаются на 3-ий сетевой уровень протоколу IP. Тот добавляет свой заголовок, где главное это ip адрес назначения 2.2.2.2 и адрес отправителя 1.1.1.1. Так же протокол ip фрагментирует TCP-сегменты, т.к. размер его пакетов максимум 1500 байт(около. Протокол на освании иформации об адресе назначения смотрит в свою таблицу маршрутизации и определяет порт за которым находится сеть хоста 2.2.2.2 в который надо направить пакет. Дальше работает протокол ARP. Он работает на стыке 3-его и 2-ого уровне TCP/IP. Определяет мак-адрес хоста назначения если они находятся в одном сегменте-L2 или мак-адрес хоста с ip next-hop, за которым по таблице маршрутизации находится сеть хоста 2.2.2.2.
4. Пакет передаётся на порт где протокол 2ого уровня Ethernet завочивает пакет в свой заголовок где главные поля это мак-адреса назчачения и отправителя. Формирует эзернет-фрейм.
5. На основе логической информации из фрейма, физическая часть 1-ого уровня TCP/IP протокола эзернет, формирует электрический сигнал(радио или оптический) и передаёт его на соседнее устройство по каналу связи(меди, оптике, радио).

6. Принимающее устройства на 1-ом уровне  декодирует электрический сигнал, передаёт логическую информацию на 2ой уровень.

7. Если принимающее устройство это устройство 2ого уровня, оно анализирует заголовок 2ого уровня и на основе информации об мак-адресе назначения передаёт пакет на тот порт с которого видит это мак-адрес. Дальше фрейм снова кодируется в электрический сигнал и передается по физической среде передачи.

8. Если принимающее устройство это устройство 3его уровня. Декодируется физический сигнал. Оно проверяет мак-адрес назначения и сверяет принадлежит ли он его порту, после чего анализирует заголовок 3-его уровня, прежде всего ip-назначения и происходит то, что было в пунктах 3, 4, 5.

9. Когда пакет дойдет до хоста назначения. Ещё раз произойдет, то что было в пунктах 6, 7, 8. Дальше протокол TCP соберёт в буффер все сегменты, склеит их обратно в сообщение почты размером 1Мбайт. И передаст его приложению которые запущенно на порту TCP 25-ого - это должен быть протокол SMTP.